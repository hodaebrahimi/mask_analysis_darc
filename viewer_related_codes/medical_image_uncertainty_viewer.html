<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Image Uncertainty Viewer</title>
    <script src="https://unpkg.com/niivue@0.44.0/dist/niivue.umd.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
            font-weight: 300;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .upload-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .file-upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .file-upload-box {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 30px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .file-upload-box:hover {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-2px);
        }
        
        .file-upload-box.dragover {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .file-upload-box input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .file-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.7;
        }
        
        .file-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        .file-status.success {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }
        
        .file-status.error {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }
        
        .controls-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .control-group {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
        }
        
        .control-group h4 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 1.1em;
        }
        
        .control-item {
            margin-bottom: 15px;
        }
        
        .control-item:last-child {
            margin-bottom: 0;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        select, button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        select:focus, button:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        
        button {
            cursor: pointer;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .viewer-container {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        #niivue-container {
            height: 600px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .status-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid;
        }
        
        .status.loading {
            background: rgba(33, 150, 243, 0.1);
            border-left-color: #2196F3;
        }
        
        .status.success {
            background: rgba(76, 175, 80, 0.1);
            border-left-color: #4CAF50;
        }
        
        .status.error {
            background: rgba(244, 67, 54, 0.1);
            border-left-color: #f44336;
        }
        
        .colorbar {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }
        
        .colorbar-gradient {
            width: 300px;
            height: 30px;
            background: linear-gradient(to right, 
                rgba(0,0,255,1) 0%, 
                rgba(0,255,255,1) 25%, 
                rgba(255,255,0,1) 50%, 
                rgba(255,128,0,1) 75%, 
                rgba(255,0,0,1) 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            margin: 0 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .stats-display {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .volume-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .info-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 5px;
        }
        
        @media (max-width: 768px) {
            .file-upload-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .volume-info {
                grid-template-columns: 1fr;
            }
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            z-index: 10;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 Medical Image Uncertainty Viewer</h1>
            <p>Advanced visualization tool for medical volumes and uncertainty masks</p>
        </div>

        <div class="upload-section">
            <h3>📁 Load Medical Files</h3>
            <div class="file-upload-grid">
                <div class="file-upload-box" id="volume-upload-box">
                    <input type="file" id="volume-file" accept=".nii.gz,.nii" />
                    <div class="file-icon">🏥</div>
                    <h4>Volume File</h4>
                    <p>Upload main medical image<br>(.nii.gz or .nii)</p>
                    <div class="file-status" id="volume-status"></div>
                </div>
                
                <div class="file-upload-box" id="mask-upload-box">
                    <input type="file" id="mask-file" accept=".nii.gz,.nii" />
                    <div class="file-icon">🎯</div>
                    <h4>Uncertainty Mask</h4>
                    <p>Upload uncertainty segmentation<br>(.nii.gz or .nii)</p>
                    <div class="file-status" id="mask-status"></div>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button id="load-btn" onclick="loadFiles()" disabled>
                    🚀 Load and Visualize
                </button>
            </div>
        </div>

        <div class="controls-panel">
            <h3>🎛️ Visualization Controls</h3>
            <div class="controls-grid">
                <div class="control-group">
                    <h4>Overlay Settings</h4>
                    
                    <div class="control-item">
                        <label for="opacity-slider">Uncertainty Opacity: <span id="opacity-value">0.7</span></label>
                        <input type="range" id="opacity-slider" min="0" max="1" step="0.1" value="0.7" onchange="updateOpacity()" />
                    </div>
                    
                    <div class="control-item">
                        <label for="colormap-select">Colormap:</label>
                        <select id="colormap-select" onchange="updateColormap()">
                            <option value="red">Red (Classic)</option>
                            <option value="blue2red" selected>Blue to Red</option>
                            <option value="hot">Hot</option>
                            <option value="jet">Jet</option>
                            <option value="plasma">Plasma</option>
                            <option value="winter">Winter</option>
                        </select>
                    </div>
                </div>

                <div class="control-group">
                    <h4>Intensity Mapping</h4>
                    
                    <div class="control-item">
                        <label for="min-slider">Min Threshold: <span id="min-value">0.00</span></label>
                        <input type="range" id="min-slider" min="0" max="1" step="0.01" value="0" onchange="updateIntensity()" />
                    </div>
                    
                    <div class="control-item">
                        <label for="max-slider">Max Threshold: <span id="max-value">1.00</span></label>
                        <input type="range" id="max-slider" min="0" max="1" step="0.01" value="1" onchange="updateIntensity()" />
                    </div>
                </div>

                <div class="control-group">
                    <h4>View Controls</h4>
                    
                    <div class="control-item">
                        <button onclick="resetView()">🔄 Reset View</button>
                    </div>
                    
                    <div class="control-item">
                        <button onclick="toggleCrosshair()">✚ Toggle Crosshair</button>
                    </div>
                    
                    <div class="control-item">
                        <button onclick="showStatistics()">📊 Show Statistics</button>
                    </div>
                    
                    <div class="control-item">
                        <button onclick="captureScreenshot()">📸 Screenshot</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="viewer-container">
            <div id="niivue-container">
                <div class="loading-overlay" id="loading-overlay" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>
            </div>
            
            <div class="colorbar">
                <span>Low Uncertainty</span>
                <div class="colorbar-gradient"></div>
                <span>High Uncertainty</span>
            </div>
        </div>

        <div class="status-panel">
            <div class="status loading" id="main-status">
                <strong>Status:</strong> Ready to load files. Please upload both volume and uncertainty mask.
            </div>
            
            <div class="stats-display" id="stats-display" style="display: none;">
                <h4>📈 Volume Statistics</h4>
                <div id="stats-content"></div>
            </div>
        </div>
    </div>

    <script>
        let nv = null;
        let volumeFile = null;
        let maskFile = null;
        let filesLoaded = false;

        // Initialize NiiVue when page loads
        window.addEventListener('load', function() {
            try {
                if (typeof Niivue === 'undefined') {
                    updateStatus('NiiVue library failed to load. Please check your internet connection.', 'error');
                    return;
                }

                nv = new Niivue.Niivue();
                nv.attachTo('niivue-container');

                // Configure NiiVue settings
                nv.opts.dragAndDropEnabled = true;
                nv.opts.backColor = [0.1, 0.1, 0.1, 1];
                nv.opts.crosshairColor = [1, 1, 1, 0.8];
                nv.opts.show3Dcrosshair = true;
                nv.opts.isColorbar = false; // We'll use our custom colorbar

                updateStatus('Viewer initialized. Upload your files to get started!', 'success');
                console.log('NiiVue initialized successfully');

            } catch (error) {
                updateStatus(`Failed to initialize viewer: ${error.message}`, 'error');
                console.error('Initialization error:', error);
            }
        });

        // File upload handling
        document.getElementById('volume-file').addEventListener('change', function(e) {
            handleFileUpload(e, 'volume');
        });

        document.getElementById('mask-file').addEventListener('change', function(e) {
            handleFileUpload(e, 'mask');
        });

        // Drag and drop handling
        ['volume-upload-box', 'mask-upload-box'].forEach(id => {
            const box = document.getElementById(id);
            
            box.addEventListener('dragover', (e) => {
                e.preventDefault();
                box.classList.add('dragover');
            });
            
            box.addEventListener('dragleave', (e) => {
                e.preventDefault();
                box.classList.remove('dragover');
            });
            
            box.addEventListener('drop', (e) => {
                e.preventDefault();
                box.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const type = id.includes('volume') ? 'volume' : 'mask';
                    const input = document.getElementById(type + '-file');
                    input.files = files;
                    handleFileUpload({ target: input }, type);
                }
            });
        });

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            const statusElement = document.getElementById(type + '-status');
            
            if (!file) return;

            // Validate file type
            if (!file.name.toLowerCase().includes('.nii')) {
                statusElement.innerHTML = '❌ Please select a .nii or .nii.gz file';
                statusElement.className = 'file-status error';
                return;
            }

            if (type === 'volume') {
                volumeFile = file;
                statusElement.innerHTML = `✅ ${file.name} (${formatFileSize(file.size)})`;
                statusElement.className = 'file-status success';
            } else {
                maskFile = file;
                statusElement.innerHTML = `✅ ${file.name} (${formatFileSize(file.size)})`;
                statusElement.className = 'file-status success';
            }

            // Enable load button if both files are selected
            const loadBtn = document.getElementById('load-btn');
            loadBtn.disabled = !(volumeFile && maskFile);
            
            if (loadBtn.disabled) {
                updateStatus('Please upload both volume and mask files', 'loading');
            } else {
                updateStatus('Both files loaded. Click "Load and Visualize" to begin!', 'success');
            }
        }

        async function loadFiles() {
            if (!nv || !volumeFile || !maskFile) {
                updateStatus('Please select both volume and mask files', 'error');
                return;
            }

            try {
                showLoadingOverlay(true);
                updateStatus('Loading medical images...', 'loading');

                // Clear any existing volumes
                nv.volumes = [];

                // Create object URLs for the files
                const volumeUrl = URL.createObjectURL(volumeFile);
                const maskUrl = URL.createObjectURL(maskFile);

                const volumeList = [
                    {
                        url: volumeUrl,
                        name: volumeFile.name,
                        colormap: 'gray',
                        opacity: 1.0
                    },
                    {
                        url: maskUrl,
                        name: maskFile.name,
                        colormap: 'blue2red',
                        opacity: 0.7,
                        cal_min: 0.0,
                        cal_max: 1.0
                    }
                ];

                await nv.loadVolumes(volumeList);

                // Clean up object URLs
                URL.revokeObjectURL(volumeUrl);
                URL.revokeObjectURL(maskUrl);

                if (nv.volumes.length < 2) {
                    throw new Error('Failed to load both volumes');
                }

                filesLoaded = true;
                showLoadingOverlay(false);
                updateStatus(`Successfully loaded ${nv.volumes.length} volumes! Use mouse to navigate.`, 'success');
                
                // Log volume information
                console.log('Loaded volumes:', nv.volumes.map(v => ({
                    name: v.name,
                    dims: v.dims,
                    min: v.global_min,
                    max: v.global_max
                })));

                // Apply initial settings
                setTimeout(() => {
                    forceDisplay();
                    showStatistics();
                }, 500);

            } catch (error) {
                showLoadingOverlay(false);
                updateStatus(`Failed to load files: ${error.message}`, 'error');
                console.error('Load error:', error);
            }
        }

        function forceDisplay() {
            if (!filesLoaded || nv.volumes.length < 2) return;

            try {
                const uncertaintyVol = nv.volumes[1];
                
                // Set intensity range for uncertainty mask
                uncertaintyVol.cal_min = 0.0;
                uncertaintyVol.cal_max = 1.0;
                
                // Apply current settings
                const opacity = parseFloat(document.getElementById('opacity-slider').value);
                const colormap = document.getElementById('colormap-select').value;
                
                nv.setColormap(1, colormap);
                nv.setOpacity(1, opacity);
                nv.drawScene();
                
                console.log('Display settings applied successfully');
                
            } catch (error) {
                console.error('Force display error:', error);
            }
        }

        function updateOpacity() {
            if (!filesLoaded || nv.volumes.length < 2) return;
            
            const slider = document.getElementById('opacity-slider');
            const value = parseFloat(slider.value);
            document.getElementById('opacity-value').textContent = value.toFixed(1);
            
            nv.setOpacity(1, value);
        }

        function updateColormap() {
            if (!filesLoaded || nv.volumes.length < 2) return;
            
            const select = document.getElementById('colormap-select');
            const colormap = select.value;
            
            nv.setColormap(1, colormap);
        }

        function updateIntensity() {
            if (!filesLoaded || nv.volumes.length < 2) return;
            
            const minSlider = document.getElementById('min-slider');
            const maxSlider = document.getElementById('max-slider');
            const minVal = parseFloat(minSlider.value);
            const maxVal = parseFloat(maxSlider.value);
            
            // Ensure min <= max
            if (minVal >= maxVal) {
                if (minSlider === document.activeElement) {
                    maxSlider.value = (minVal + 0.01).toString();
                } else {
                    minSlider.value = (maxVal - 0.01).toString();
                }
                return updateIntensity();
            }
            
            document.getElementById('min-value').textContent = minVal.toFixed(2);
            document.getElementById('max-value').textContent = maxVal.toFixed(2);
            
            const vol = nv.volumes[1];
            vol.cal_min = minVal;
            vol.cal_max = maxVal;
            
            nv.drawScene();
        }

        function resetView() {
            if (!nv) return;
            
            nv.scene.volScaleMultiplier = 1.0;
            nv.scene.crosshairPos = [0.5, 0.5, 0.5];
            nv.drawScene();
            
            updateStatus('View reset to default position', 'success');
        }

        function toggleCrosshair() {
            if (!nv) return;
            
            nv.opts.show3Dcrosshair = !nv.opts.show3Dcrosshair;
            nv.drawScene();
            
            const status = nv.opts.show3Dcrosshair ? 'enabled' : 'disabled';
            updateStatus(`Crosshair ${status}`, 'success');
        }

        function showStatistics() {
            if (!filesLoaded || nv.volumes.length < 2) return;

            const volumeVol = nv.volumes[0];
            const uncertaintyVol = nv.volumes[1];
            
            let statsHtml = '<div class="volume-info">';
            
            // Volume statistics
            statsHtml += `
                <div class="info-item">
                    <strong>📊 Volume Info</strong><br>
                    Name: ${volumeVol.name}<br>
                    Dimensions: ${volumeVol.dims.join(' × ')}<br>
                    Intensity: ${volumeVol.global_min.toFixed(2)} - ${volumeVol.global_max.toFixed(2)}
                </div>
            `;
            
            // Uncertainty mask statistics
            if (uncertaintyVol.img) {
                const img = uncertaintyVol.img;
                let nonZeroCount = 0;
                let sum = 0;
                let min = Infinity;
                let max = -Infinity;
                
                for (let i = 0; i < img.length; i++) {
                    if (img[i] > 0) {
                        nonZeroCount++;
                        sum += img[i];
                        min = Math.min(min, img[i]);
                        max = Math.max(max, img[i]);
                    }
                }
                
                const mean = nonZeroCount > 0 ? sum / nonZeroCount : 0;
                const coverage = (nonZeroCount / img.length * 100).toFixed(1);
                
                statsHtml += `
                    <div class="info-item">
                        <strong>🎯 Uncertainty Info</strong><br>
                        Name: ${uncertaintyVol.name}<br>
                        Coverage: ${coverage}% of volume<br>
                        Range: ${min.toFixed(4)} - ${max.toFixed(4)}<br>
                        Mean: ${mean.toFixed(4)}
                    </div>
                `;
            }
            
            statsHtml += '</div>';
            
            const statsDisplay = document.getElementById('stats-display');
            const statsContent = document.getElementById('stats-content');
            statsContent.innerHTML = statsHtml;
            statsDisplay.style.display = 'block';
            
            updateStatus('Statistics updated', 'success');
        }

        function captureScreenshot() {
            if (!nv || !filesLoaded) {
                updateStatus('No image to capture', 'error');
                return;
            }

            try {
                const canvas = nv.canvas;
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                link.download = `uncertainty_view_${timestamp}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                updateStatus('Screenshot saved!', 'success');
            } catch (error) {
                updateStatus('Screenshot failed: ' + error.message, 'error');
            }
        }

        // Utility functions
        function updateStatus(message, type = 'loading') {
            const statusElement = document.getElementById('main-status');
            statusElement.innerHTML = `<strong>Status:</strong> ${message}`;
            statusElement.className = `status ${type}`;
        }

        function showLoadingOverlay(show) {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Enable file drop on the entire viewer
        document.getElementById('niivue-container').addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        document.getElementById('niivue-container').addEventListener('drop', (e) => {
            e.preventDefault();
            const files = Array.from(e.dataTransfer.files).filter(f => f.name.toLowerCase().includes('.nii'));
            
            if (files.length > 0) {
                updateStatus(`Dropped ${files.length} file(s). Please use the upload boxes above to specify which is volume vs mask.`, 'loading');
            }
        });
    </script>
</body>
</html>